<div id="conversation" class="col-span-4 sm:col-span-3 flex flex-col bg-white rounded-r-2xl relative h-[calc(100vh-8rem)]">
    
    <!-- Chat Header -->
    {% if conversation %}
    <div class="p-4 border-b flex items-center gap-4 bg-white">
        {% for participant in conversation.participants.all %}
        {% if participant != request.user %}
        <a href="{% url 'userprofile' participant.username %}">
            <img class="w-12 h-12 rounded-full" src="{{ participant.profile.avatar }}">
        </a>
        <div>
            <h1 class="text-lg font-bold">{{ participant.profile.name }}</h1>
            <div class="text-gray-500 text-sm">@{{ participant.username }}</div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Messages Container (Scrolls from Bottom) -->
    <div id="messages-container" class="flex-grow overflow-y-auto h-full p-4 flex flex-col-reverse">
        <ul id="inbox-messages" class="flex flex-col gap-4">
            {% for message in conversation.messages.all %}
            <li class="flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %} space-x-2">
                
                <!-- Avatar for incoming messages -->
                {% if message.sender != request.user %}
                <a href="{% url 'userprofile' message.sender.username %}">
                    <img class="w-10 h-10 rounded-full" src="{{ message.sender.profile.avatar }}">
                </a>
                {% endif %}

                <!-- Message Bubble -->
                <div class="{% if message.sender == request.user %}bg-indigo-600 text-white{% else %}bg-gray-200 text-gray-900{% endif %} px-4 py-2 rounded-2xl max-w-md sm:max-w-lg shadow-md">
                    <p class="text-sm whitespace-pre-wrap">{{ message.body_decrypted }}</p>
                    <p class="text-xs text-gray-400 mt-1">{{ message.created|timesince }} ago</p>
                </div>

            </li>
            {% empty %}
            <!-- If there are no messages -->
            <li class="text-center text-gray-500">No messages yet. Start the conversation!</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Sticky Reply Button -->
      <div class="sticky bottom-0 z-10 px-4 sm:px-10 pt-6 pb-10 flex bg-white">
        <a class="flex items-center gap-2 bg-gray-800 hover:bg-indigo-600 text-white rounded-full px-4 py-2 transition duration-300 ease-in-out"
        hx-get="{% url 'inbox-newreply' conversation.id %}"
        hx-target="#inbox-messages"
        hx-swap="beforeend"
        onclick="scrollToBottom(true)">
            <img class="h-6" src="https://img.icons8.com/material/96/ffffff/reply-arrow--v1.png">
            <span class="text-white font-medium">Reply</span>  
        </a>
    </div>
 
   
    

    {% else %}
    <div class="h-full flex items-center justify-center text-gray-500 -mt-6 text-center p-10">
        Select a conversation or create a new one.
    </div>
    {% endif %}
</div>

<!-- JavaScript for Auto-Scrolling to Bottom -->
<script>
    function scrollToBottom(force = false) {
        let messagesContainer = document.getElementById("messages-container");

        if (messagesContainer) {
            if (force) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: "smooth"
                });
            }
        }
    }

    // Scroll to bottom when the page loads
    window.onload = function() {
        scrollToBottom(true);
    };

    // Scroll to bottom when new messages arrive (HTMX event)
    document.body.addEventListener("htmx:afterSwap", function(event) {
        scrollToBottom();
    });
</script>
